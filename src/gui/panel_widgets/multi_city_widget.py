#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
Universal Weather Research Platform - Multi-City Widget
Magyar R√©gi√≥k √©s Megy√©k v√°laszt√≥ widget (Analysis type alap√∫) - DROPDOWN verzi√≥

üéØ CLEAN ARCHITECTURE REFAKTOR - MULTI-CITY T√ÅMOGAT√ÅS - DROPDOWN UI
Felel≈ëss√©g: CSAK a r√©gi√≥/megye v√°laszt√°s kezel√©se multi-city m√≥dban
- Single Responsibility: Csak multi-city location selection
- Clean Interface: get_state(), set_state(), selection_changed signal
- Analysis type alap√∫ mode v√°lt√°s (region vs county)
- DROPDOWN UI: QComboBox egyszer≈± v√°laszt√°ssal
- üö® FIX: ComboBox inicializ√°l√°si probl√©ma jav√≠tva
"""

from typing import Optional, Dict, Any, List
from PySide6.QtWidgets import (
    QWidget, QVBoxLayout, QHBoxLayout, QGroupBox, QComboBox, 
    QPushButton, QLabel
)
from PySide6.QtCore import Signal, Qt

from ..theme_manager import get_theme_manager, register_widget_for_theming
from ...data.city_manager import CityManager


class MultiCityWidget(QWidget):
    """
    üèôÔ∏è MULTI-CITY V√ÅLASZT√ì WIDGET - DROPDOWN VERSION
    
    Felel≈ëss√©g:
    - Magyar r√©gi√≥k/megy√©k dropdown v√°laszt√°s (QComboBox)
    - Analysis type alap√∫ mode v√°lt√°s (region vs county)
    - Single selection state management
    - Selection info display (pl. "K√∂z√©p-Magyarorsz√°g (2 megye)")
    
    Interface:
    - selection_changed = Signal(dict) - kiv√°laszt√°s v√°ltoz√°s
    - get_state() -> dict - aktu√°lis √°llapot
    - set_state(dict) - √°llapot be√°ll√≠t√°sa
    - is_valid() -> bool - van-e kiv√°laszt√°s
    - set_analysis_mode(str) - "region" vagy "county" mode
    """
    
    # === KIMEN≈ê SIGNAL ===
    selection_changed = Signal(dict)  # {"mode": "region", "selected": "K√∂z√©p-Magyarorsz√°g", "is_valid": True}
    
    def __init__(self, city_manager: CityManager, parent: Optional[QWidget] = None):
        """
        MultiCityWidget inicializ√°l√°sa.
        
        Args:
            city_manager: CityManager instance (magyar adatok lek√©rdez√©shez)
            parent: Sz√ºl≈ë widget
        """
        super().__init__(parent)
        
        # Dependencies
        self.city_manager = city_manager
        self.theme_manager = get_theme_manager()
        
        # State
        self._current_mode = "region"  # "region" vagy "county"
        self._selected_region: Optional[str] = None
        self._selected_county: Optional[str] = None
        self._updating_state = False
        
        # Data sources
        self._available_regions = self._get_hungarian_regions()
        self._available_counties = []  # Bet√∂ltj√ºk k√©s≈ëbb
        
        # UI init
        self._init_ui()
        self._load_data()
        self._connect_signals()
        self._register_for_theming()
        
        # üö® KRITIKUS FIX: ComboBox inicializ√°l√°sa R√ñGT√ñN!
        self._populate_combo_box()
        self._update_group_title()
        self._update_info_label()
        
        print("üèôÔ∏è DEBUG: MultiCityWidget (DROPDOWN) inicializ√°lva - Clean Architecture + COMBO FIX")
    
    def _init_ui(self) -> None:
        """UI elemek l√©trehoz√°sa - DROPDOWN VERSION."""
        # Main layout
        layout = QVBoxLayout(self)
        layout.setContentsMargins(0, 0, 0, 0)
        layout.setSpacing(0)
        
        # Group box
        self.group = QGroupBox("üèôÔ∏è Multi-City V√°laszt√≥")
        group_layout = QVBoxLayout(self.group)
        group_layout.setContentsMargins(12, 16, 12, 12)
        group_layout.setSpacing(12)
        
        # Dropdown combo box
        self.combo_box = QComboBox()
        self.combo_box.setMinimumHeight(35)
        self.combo_box.setEditable(False)
        # üö® FIX: ComboBox ENABLED √°llapotban kell legyen!
        self.combo_box.setEnabled(True)
        group_layout.addWidget(self.combo_box)
        
        # Selection info label
        self.info_label = QLabel("V√°lasszon r√©gi√≥t vagy megy√©t...")
        self.info_label.setWordWrap(True)
        self.info_label.setMinimumHeight(40)
        group_layout.addWidget(self.info_label)
        
        # Control buttons
        control_layout = QHBoxLayout()
        control_layout.setSpacing(8)
        
        self.clear_btn = QPushButton("‚ùå V√°laszt√°s t√∂rl√©se")
        self.clear_btn.clicked.connect(self._clear_selection)
        self.clear_btn.setEnabled(False)
        control_layout.addWidget(self.clear_btn)
        
        # Spacer
        control_layout.addStretch()
        
        group_layout.addLayout(control_layout)
        
        # Size constraints
        self.group.setMinimumHeight(150)
        self.group.setMaximumHeight(180)
        
        layout.addWidget(self.group)
    
    def _load_data(self) -> None:
        """Magyar r√©gi√≥k √©s megy√©k adatainak bet√∂lt√©se."""
        try:
            # Megy√©k bet√∂lt√©se city_manager-b≈ël
            self._available_counties = self.city_manager.get_hungarian_counties()
            print(f"üèõÔ∏è DEBUG: Bet√∂lt√∂tt megy√©k: {len(self._available_counties)} db")
            print(f"üìã DEBUG: Megy√©k list√°ja: {self._available_counties[:5]}...")  # Els≈ë 5
            
        except Exception as e:
            print(f"‚ùå ERROR: Adatok bet√∂lt√©si hiba: {e}")
            self._available_counties = []
    
    def _get_hungarian_regions(self) -> List[str]:
        """
        Magyar NUTS r√©gi√≥k list√°ja (hungarian_settlements_importer.py alapj√°n).
        
        Returns:
            7 magyar statisztikai r√©gi√≥ list√°ja
        """
        return [
            "K√∂z√©p-Magyarorsz√°g",     # Budapest + Pest
            "K√∂z√©p-Dun√°nt√∫l",         # Fej√©r + Kom√°rom-Esztergom + Veszpr√©m
            "Nyugat-Dun√°nt√∫l",        # Gy≈ër-Moson-Sopron + Vas + Zala
            "D√©l-Dun√°nt√∫l",           # Baranya + Somogy + Tolna
            "√âszak-Magyarorsz√°g",     # Borsod-Aba√∫j-Zempl√©n + Heves + N√≥gr√°d
            "√âszak-Alf√∂ld",           # Hajd√∫-Bihar + J√°sz-Nagykun-Szolnok + Szabolcs-Szatm√°r-Bereg
            "D√©l-Alf√∂ld"              # B√°cs-Kiskun + B√©k√©s + Csongr√°d-Csan√°d
        ]
    
    def _get_counties_for_region(self, region: str) -> List[str]:
        """
        R√©gi√≥hoz tartoz√≥ megy√©k list√°ja (hungarian_settlements_importer.py alapj√°n).
        
        Args:
            region: R√©gi√≥ neve
            
        Returns:
            Megy√©k list√°ja
        """
        region_county_mapping = {
            "K√∂z√©p-Magyarorsz√°g": ["Budapest", "Pest"],
            "K√∂z√©p-Dun√°nt√∫l": ["Fej√©r", "Kom√°rom-Esztergom", "Veszpr√©m"],
            "Nyugat-Dun√°nt√∫l": ["Gy≈ër-Moson-Sopron", "Vas", "Zala"],
            "D√©l-Dun√°nt√∫l": ["Baranya", "Somogy", "Tolna"],
            "√âszak-Magyarorsz√°g": ["Borsod-Aba√∫j-Zempl√©n", "Heves", "N√≥gr√°d"],
            "√âszak-Alf√∂ld": ["Hajd√∫-Bihar", "J√°sz-Nagykun-Szolnok", "Szabolcs-Szatm√°r-Bereg"],
            "D√©l-Alf√∂ld": ["B√°cs-Kiskun", "B√©k√©s", "Csongr√°d-Csan√°d"]
        }
        
        return region_county_mapping.get(region, [])
    
    def _connect_signals(self) -> None:
        """Signal-slot kapcsolatok."""
        self.combo_box.currentTextChanged.connect(self._on_combo_selection_changed)
    
    def _register_for_theming(self) -> None:
        """Theme manager regisztr√°ci√≥."""
        register_widget_for_theming(self, "container")
        register_widget_for_theming(self.group, "container")
        register_widget_for_theming(self.combo_box, "input")
        register_widget_for_theming(self.clear_btn, "button")
        
        # Info label styling
        self._apply_label_styling(self.info_label, "secondary")
    
    def _apply_label_styling(self, label: QLabel, style_type: str) -> None:
        """Label styling alkalmaz√°sa."""
        color_palette = self.theme_manager.get_color_scheme()
        if not color_palette:
            return
        
        if style_type == "secondary":
            color = color_palette.get_color("info", "light") or "#9ca3af"
            font_size = "11px"
        elif style_type == "primary":
            color = color_palette.get_color("primary", "base") or "#2563eb"
            font_size = "12px"
        else:
            return
        
        css = f"QLabel {{ color: {color}; font-size: {font_size}; }}"
        label.setStyleSheet(css)
        
        register_widget_for_theming(label, "text")
    
    # === ANALYSIS MODE MANAGEMENT ===
    
    def set_analysis_mode(self, mode: str) -> None:
        """
        Analysis mode be√°ll√≠t√°sa.
        
        Args:
            mode: "region" vagy "county"
        """
        if mode not in ["region", "county"]:
            print(f"‚ùå ERROR: Invalid analysis mode: {mode}")
            return
        
        if mode == self._current_mode:
            print(f"üîÑ DEBUG: Mode already set to {mode}, skipping...")
            return  # Nincs v√°ltoz√°s
        
        print(f"üîÑ DEBUG: Analysis mode v√°lt√°s: {self._current_mode} ‚Üí {mode}")
        
        self._current_mode = mode
        self._populate_combo_box()
        self._update_group_title()
        self._update_info_label()
        
        print(f"‚úÖ DEBUG: Analysis mode v√°lt√°s befejezve: {mode}")
    
    def _populate_combo_box(self) -> None:
        """
        üö® KRITIKUS FIX: ComboBox felt√∂lt√©se aktu√°lis mode alapj√°n.
        Most m√°r biztosan h√≠v√≥dik inicializ√°l√°skor is!
        """
        print(f"üîÑ DEBUG: _populate_combo_box() started - mode: {self._current_mode}")
        
        self._updating_state = True
        
        try:
            self.combo_box.clear()
            
            # Els≈ë elem: placeholder
            if self._current_mode == "region":
                self.combo_box.addItem("-- V√°lasszon r√©gi√≥t --")
                
                # R√©gi√≥k hozz√°ad√°sa
                for region in self._available_regions:
                    counties = self._get_counties_for_region(region)
                    item_text = f"{region} ({len(counties)} megye)"
                    self.combo_box.addItem(item_text, region)  # userData = region n√©v
                
                print(f"üèûÔ∏è DEBUG: ComboBox felt√∂ltve {len(self._available_regions)} r√©gi√≥val")
                
            elif self._current_mode == "county":
                self.combo_box.addItem("-- V√°lasszon megy√©t --")
                
                # Megy√©k hozz√°ad√°sa
                for county in self._available_counties:
                    item_text = f"{county} megye"
                    self.combo_box.addItem(item_text, county)  # userData = county n√©v
                
                print(f"üèõÔ∏è DEBUG: ComboBox felt√∂ltve {len(self._available_counties)} megy√©vel")
            
            # üö® KRITIKUS FIX: ComboBox ENABLED √°llapot biztos√≠t√°sa
            self.combo_box.setEnabled(True)
            print(f"‚úÖ DEBUG: ComboBox enabled state: {self.combo_box.isEnabled()}")
            
            # State restoration
            self._restore_selection_after_populate()
            
        except Exception as e:
            print(f"‚ùå ERROR: ComboBox populate hiba: {e}")
        finally:
            self._updating_state = False
            print(f"‚úÖ DEBUG: _populate_combo_box() completed")
    
    def _restore_selection_after_populate(self) -> None:
        """Selection vissza√°ll√≠t√°sa combo box populate ut√°n."""
        if self._current_mode == "region" and self._selected_region:
            # R√©gi√≥ keres√©se √©s be√°ll√≠t√°sa
            for i in range(1, self.combo_box.count()):  # Skip placeholder (index 0)
                if self.combo_box.itemData(i) == self._selected_region:
                    self.combo_box.setCurrentIndex(i)
                    print(f"üîÑ DEBUG: R√©gi√≥ vissza√°ll√≠tva: {self._selected_region}")
                    break
        
        elif self._current_mode == "county" and self._selected_county:
            # Megye keres√©se √©s be√°ll√≠t√°sa
            for i in range(1, self.combo_box.count()):  # Skip placeholder (index 0)
                if self.combo_box.itemData(i) == self._selected_county:
                    self.combo_box.setCurrentIndex(i)
                    print(f"üîÑ DEBUG: Megye vissza√°ll√≠tva: {self._selected_county}")
                    break
    
    def _update_group_title(self) -> None:
        """Group box title friss√≠t√©se mode szerint."""
        if self._current_mode == "region":
            self.group.setTitle("üèûÔ∏è R√©gi√≥ V√°laszt√≥ (Multi-City)")
        else:
            self.group.setTitle("üèõÔ∏è Megye V√°laszt√≥ (Multi-City)")
    
    # === COMBO BOX SIGNAL HANDLER ===
    
    def _on_combo_selection_changed(self, text: str) -> None:
        """ComboBox selection v√°ltoz√°s kezel√©se."""
        if self._updating_state:
            print(f"‚è∏Ô∏è DEBUG: Skipping combo change (updating state): {text}")
            return
        
        current_index = self.combo_box.currentIndex()
        print(f"üîÑ DEBUG: Combo selection changed - index: {current_index}, text: '{text}'")
        
        # Placeholder v√°laszt√°s (index 0) - t√∂rl√©s
        if current_index == 0:
            print(f"üîÑ DEBUG: Placeholder selected - clearing selection")
            self._clear_current_selection()
            return
        
        # √ârv√©nyes v√°laszt√°s
        selected_data = self.combo_box.currentData()
        print(f"‚úÖ DEBUG: Valid selection - data: {selected_data}")
        
        if self._current_mode == "region":
            self._selected_region = selected_data
            self._selected_county = None  # Clear other mode
            print(f"üèûÔ∏è DEBUG: R√©gi√≥ kiv√°lasztva: {self._selected_region}")
            
        elif self._current_mode == "county":
            self._selected_county = selected_data
            self._selected_region = None  # Clear other mode
            print(f"üèõÔ∏è DEBUG: Megye kiv√°lasztva: {self._selected_county}")
        
        self._update_info_label()
        self._update_clear_button()
        self._emit_selection_changed()
    
    def _clear_current_selection(self) -> None:
        """Aktu√°lis mode selection t√∂rl√©se."""
        if self._current_mode == "region":
            self._selected_region = None
            print(f"üèûÔ∏è DEBUG: R√©gi√≥ selection t√∂r√∂lve")
        else:
            self._selected_county = None
            print(f"üèõÔ∏è DEBUG: Megye selection t√∂r√∂lve")
        
        self._update_info_label()
        self._update_clear_button()
        self._emit_selection_changed()
    
    def _emit_selection_changed(self) -> None:
        """Selection changed signal kibocs√°t√°sa."""
        current_selection = self._get_current_selection()
        
        selection_data = {
            "mode": self._current_mode,
            "selected": current_selection,
            "is_valid": self.is_valid(),
            "selection_text": self._get_selection_display_text()
        }
        
        self.selection_changed.emit(selection_data)
        print(f"üì° DEBUG: selection_changed signal emitted: {selection_data}")
    
    def _get_current_selection(self) -> Optional[str]:
        """Aktu√°lis kiv√°laszt√°s lek√©rdez√©se mode szerint."""
        if self._current_mode == "region":
            return self._selected_region
        else:
            return self._selected_county
    
    def _get_selection_display_text(self) -> str:
        """Kiv√°laszt√°s megjelen√≠t√©si sz√∂vege."""
        if self._current_mode == "region" and self._selected_region:
            counties = self._get_counties_for_region(self._selected_region)
            return f"{self._selected_region} ({len(counties)} megye)"
        elif self._current_mode == "county" and self._selected_county:
            return f"{self._selected_county} megye"
        else:
            return ""
    
    def _update_info_label(self) -> None:
        """Info label friss√≠t√©se."""
        current_selection = self._get_current_selection()
        
        if not current_selection:
            if self._current_mode == "region":
                text = "V√°lasszon r√©gi√≥t az elemz√©shez..."
            else:
                text = "V√°lasszon megy√©t az elemz√©shez..."
            self._apply_label_styling(self.info_label, "secondary")
        else:
            display_text = self._get_selection_display_text()
            
            if self._current_mode == "region":
                text = f"üèûÔ∏è Kiv√°lasztott r√©gi√≥: {display_text}"
            else:
                text = f"üèõÔ∏è Kiv√°lasztott megye: {display_text}"
            
            self._apply_label_styling(self.info_label, "primary")
        
        self.info_label.setText(text)
    
    def _update_clear_button(self) -> None:
        """Clear button √°llapot friss√≠t√©se."""
        has_selection = self._get_current_selection() is not None
        self.clear_btn.setEnabled(has_selection)
    
    # === CONTROL BUTTON HANDLERS ===
    
    def _clear_selection(self) -> None:
        """Kiv√°laszt√°s t√∂rl√©se."""
        if self._updating_state:
            return
        
        print(f"‚ùå DEBUG: Selection t√∂rl√©se - {self._current_mode} mode")
        
        self._updating_state = True
        
        try:
            # ComboBox-ot placeholder-re √°ll√≠t√°s
            self.combo_box.setCurrentIndex(0)
            
            # State t√∂rl√©se
            self._clear_current_selection()
            
        finally:
            self._updating_state = False
    
    # === PUBLIKUS INTERFACE ===
    
    def get_state(self) -> Dict[str, Any]:
        """
        Aktu√°lis √°llapot lek√©rdez√©se.
        
        Returns:
            Dict az aktu√°lis √°llapottal
        """
        current_selection = self._get_current_selection()
        
        return {
            "mode": self._current_mode,
            "selected_region": self._selected_region,
            "selected_county": self._selected_county,
            "current_selection": current_selection,
            "selection_count": 1 if current_selection else 0,
            "is_valid": self.is_valid(),
            "selection_text": self._get_selection_display_text()
        }
    
    def set_state(self, state: Dict[str, Any]) -> bool:
        """
        √Ållapot be√°ll√≠t√°sa.
        
        Args:
            state: Be√°ll√≠tand√≥ √°llapot dict
            
        Returns:
            bool: Sikeres volt-e a be√°ll√≠t√°s
        """
        try:
            self._updating_state = True
            
            # Mode be√°ll√≠t√°sa
            mode = state.get("mode", "region")
            if mode != self._current_mode:
                self.set_analysis_mode(mode)
            
            # Selections restoration
            if "selected_region" in state:
                self._selected_region = state["selected_region"]
            
            if "selected_county" in state:
                self._selected_county = state["selected_county"]
            
            # ComboBox friss√≠t√©se
            self._restore_selection_after_populate()
            self._update_info_label()
            self._update_clear_button()
            
            print(f"‚úÖ DEBUG: MultiCityWidget state restored successfully")
            return True
            
        except Exception as e:
            print(f"‚ùå ERROR: Failed to set MultiCityWidget state: {e}")
            return False
        finally:
            self._updating_state = False
    
    def is_valid(self) -> bool:
        """
        Valid√°ci√≥ - van-e kiv√°laszt√°s.
        
        Returns:
            bool: True ha van kiv√°laszt√°s
        """
        return self._get_current_selection() is not None
    
    def clear_selection(self) -> None:
        """Kiv√°laszt√°s t√∂rl√©se."""
        self._clear_selection()
    
    def get_selected_cities(self) -> List[Dict[str, Any]]:
        """
        Kiv√°lasztott r√©gi√≥/megye v√°rosainak lek√©rdez√©se.
        
        Returns:
            V√°rosok list√°ja koordin√°t√°kkal
        """
        cities = []
        current_selection = self._get_current_selection()
        
        if not current_selection:
            return cities
        
        try:
            if self._current_mode == "region":
                # R√©gi√≥ eset√©n a r√©gi√≥hoz tartoz√≥ megy√©k v√°rosai
                counties = self._get_counties_for_region(current_selection)
                for county in counties:
                    county_cities = self.city_manager.get_hungarian_settlements_by_county(county, limit=50)
                    cities.extend([city.to_dict() for city in county_cities])
            
            else:
                # Megye eset√©n k√∂zvetlen√ºl
                county_cities = self.city_manager.get_hungarian_settlements_by_county(current_selection, limit=50)
                cities.extend([city.to_dict() for city in county_cities])
            
            print(f"üèôÔ∏è DEBUG: Kiv√°lasztott v√°rosok: {len(cities)} db ({self._current_mode}: {current_selection})")
            return cities
            
        except Exception as e:
            print(f"‚ùå ERROR: Cities lek√©rdez√©si hiba: {e}")
            return []
    
    def get_current_mode(self) -> str:
        """Aktu√°lis mode lek√©rdez√©se."""
        return self._current_mode
    
    def get_selection_summary(self) -> str:
        """Kiv√°laszt√°s √∂sszefoglal√°sa string form√°ban."""
        current_selection = self._get_current_selection()
        
        if not current_selection:
            return "Nincs kiv√°laszt√°s"
        elif self._current_mode == "region":
            counties = self._get_counties_for_region(current_selection)
            return f"R√©gi√≥: {current_selection} ({len(counties)} megye)"
        else:
            return f"Megye: {current_selection}"
    
    def set_enabled(self, enabled: bool) -> None:
        """
        Widget enged√©lyez√©se/letilt√°sa.
        
        Args:
            enabled: Enged√©lyezett √°llapot
        """
        self.group.setEnabled(enabled)
        self.combo_box.setEnabled(enabled)
        self.clear_btn.setEnabled(enabled and self.is_valid())
        
        print(f"üèôÔ∏è DEBUG: MultiCityWidget enabled state: {enabled}")
        print(f"üîß DEBUG: ComboBox enabled after set_enabled: {self.combo_box.isEnabled()}")
    
    # === SIZE HINT ===
    
    def sizeHint(self):
        """Prefer√°lt m√©ret."""
        return self.group.sizeHint()
    
    def minimumSizeHint(self):
        """Minimum m√©ret."""
        return self.group.minimumSizeHint()